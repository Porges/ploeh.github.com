---
layout: post
tags: [AutoFixture, Dependency Injection]
date: 2011-04-19 06:59:19 UTC
title: "Constructor strategies for AutoFixture"
---
{% include JB/setup %}

<div id="post">
	<p>When <a href="http://autofixture.codeplex.com/">AutoFixture</a> creates complex objects it invokes the constructors of the types in question. When a class exposes more than one constructor, the <a href="http://blog.ploeh.dk/2009/03/24/HowAutoFixtureCreatesObjects">default behavior is to pick the constructor with the fewest number&nbsp; of arguments</a>. This is the exact opposite of most DI Containers that select the greediest constructor.</p> <p>For a DI Container it makes more sense to select the greediest constructor because that maximizes the chance that all dependencies are properly being auto-wired.</p> <p>The reason that AutoFixture's default behavior is different is that it maximizes the chance that an object graph can be created at all. If a convenience overload is available, this gives AutoFixture a better chance to compose the object graph.</p> <p align="left">This works well until a class comes along and introduces the wrong kind of ambiguity. Consider this case of <em>Bastard Injection</em> (<a href="http://amzn.to/12p90MG">Dependency Injection in .NET</a>, section 5.2):</p>
    <p>
        <pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"> <span style="color: "><font color="#0000ff">class</font></span> </font><span style="color: "><font style="font-size: 10pt" color="#2b91af">Bastard</font></span>
<font style="font-size: 10pt">{</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">private</font></span> <span style="color: "><font color="#0000ff">readonly</font></span> <span style="color: "><font color="#2b91af">IFoo</font></span> foo;</font>
<font style="font-size: 10pt">&nbsp;</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> Bastard()</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : <span style="color: "><font color="#0000ff">this</font></span>(<span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">DefaultFoo</font></span>())</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; {</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; }</font>
<font style="font-size: 10pt">&nbsp;</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> Bastard(<span style="color: "><font color="#2b91af">IFoo</font></span> foo)</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; {</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">if</font></span> (foo == <span style="color: "><font color="#0000ff">null</font></span>)</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">throw</font></span> <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">ArgumentNullException</font></span>(<span style="color: "><font color="#a31515">"foo"</font></span>);</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font>
<font style="font-size: 10pt">&nbsp;</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">this</font></span>.foo = foo;</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; }</font>
<font style="font-size: 10pt">&nbsp;</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">public</font></span> <span style="color: "><font color="#2b91af">IFoo</font></span> Foo</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; {</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">get</font></span> { <span style="color: "><font color="#0000ff">return</font></span> <span style="color: "><font color="#0000ff">this</font></span>.foo; }</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; }</font>
<font style="font-size: 10pt">}</font></pre>
</p>
<p align="left">By default AutoFixture will use the default constructor which means that the Foo will always be the instance of DefaultFoo owned by the Bastard class itself. This is problematic if we wish to <a href="http://blog.ploeh.dk/2010/03/27/Freezingmocks">inject and freeze a Test Double</a> because even if we freeze an IFoo instance, it will never be injected because the default constructor is being invoked.</p>
<p>
    <pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">var</font></font></span><font style="font-size: 10pt"> fixture = <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">Fixture</font></span>();</font>
<font style="font-size: 10pt">fixture.Register&lt;<span style="color: "><font color="#2b91af">IFoo</font></span>&gt;(</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; fixture.CreateAnonymous&lt;<span style="color: "><font color="#2b91af">DummyFoo</font></span>&gt;);</font>
<span style="color: "><font color="#0000ff"><font style="font-size: 10pt">var</font></font></span><font style="font-size: 10pt"> b = fixture.CreateAnonymous&lt;<span style="color: "><font color="#2b91af">Bastard</font></span>&gt;();</font>
<span style="color: "><font color="#2b91af"><font style="font-size: 10pt">Assert</font></font></span><font style="font-size: 10pt">.IsAssignableFrom&lt;<span style="color: "><font color="#2b91af">DefaultFoo</font></span>&gt;(b.Foo);</font></pre>
</p>
<p align="left">As the above unit test demonstrates, even though the Register method call defines a mapping from IFoo to DummyFoo, the Foo property is an instance of DefaultFoo. The DummyFoo instance is never injected into the Bastard instance since the default constructor is used.</p>
<p align="left">Your first reaction in such a case should be to get rid of all convenience constructors to make the the class' constructor unambiguous. However, it's also possible to change AutoFixture's behavior.</p>
<blockquote>
<p align="left">The following is a description of a feature that will be a available in AutoFixture 2.1. It's not available in AutoFixture 2.0, but is already available in the code repository. Thus, if you can't wait for AutoFixture 2.1 you can download the source and build it.</p></blockquote>
<p align="left">As always, AutoFixture's very extensible interface makes it possible to change this behavior. Constructor selection is guided by an interface called IConstructorQuery, and while ModestConstructorQuery is the default implementation, there's also an implementation called GreedyConstructorQuery.</p>
<p align="left">To change the behavior specifically for the Bastard class the Fixture instance must be customized. The following unit test demonstrates how to do that.</p>
<p>
    <pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">var</font></font></span><font style="font-size: 10pt"> fixture = <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">Fixture</font></span>();</font>
<font style="font-size: 10pt">fixture.Customize&lt;<span style="color: "><font color="#2b91af">Bastard</font></span>&gt;(c =&gt; c.FromFactory(</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">MethodInvoker</font></span>(</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">GreedyConstructorQuery</font></span>())));</font>
<font style="font-size: 10pt">fixture.Register&lt;<span style="color: "><font color="#2b91af">IFoo</font></span>&gt;(</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; fixture.CreateAnonymous&lt;<span style="color: "><font color="#2b91af">DummyFoo</font></span>&gt;);</font>
<span style="color: "><font color="#0000ff"><font style="font-size: 10pt">var</font></font></span><font style="font-size: 10pt"> b = fixture.CreateAnonymous&lt;<span style="color: "><font color="#2b91af">Bastard</font></span>&gt;();</font>
<span style="color: "><font color="#2b91af"><font style="font-size: 10pt">Assert</font></font></span><font style="font-size: 10pt">.IsAssignableFrom&lt;<span style="color: "><font color="#2b91af">DummyFoo</font></span>&gt;(b.Foo);</font></pre>
</p>
<p align="left">Notice that the only difference from before is an additional call to the Customize method where Bastard is modified to use greedy constructor selection. This changes the factory for the Bastard type, but not for any other types.</p>
<p align="left">If you'd rather prefer to completely change the overall constructor selection behavior for AutoFixture you can add the GreedyConstructorQuery wrapped in a MethodInvoker to the Fixture's Customizations:</p>
<p>
    <pre style="margin: 0px"><span style="color: "><font color="#0000ff"><font style="font-size: 10pt">var</font></font></span><font style="font-size: 10pt"> fixture = <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">Fixture</font></span>();</font>
<font style="font-size: 10pt">fixture.Customizations.Add(</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">MethodInvoker</font></span>(</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: "><font color="#0000ff">new</font></span> <span style="color: "><font color="#2b91af">GreedyConstructorQuery</font></span>()));</font>
<font style="font-size: 10pt">fixture.Register&lt;<span style="color: "><font color="#2b91af">IFoo</font></span>&gt;(</font>
<font style="font-size: 10pt">&nbsp;&nbsp;&nbsp; fixture.CreateAnonymous&lt;<span style="color: "><font color="#2b91af">DummyFoo</font></span>&gt;);</font>
<span style="color: "><font color="#0000ff"><font style="font-size: 10pt">var</font></font></span><font style="font-size: 10pt"> b = fixture.CreateAnonymous&lt;<span style="color: "><font color="#2b91af">Bastard</font></span>&gt;();</font>
<span style="color: "><font color="#2b91af"><font style="font-size: 10pt">Assert</font></font></span><font style="font-size: 10pt">.IsAssignableFrom&lt;<span style="color: "><font color="#2b91af">DummyFoo</font></span>&gt;(b.Foo);</font></pre>
</p>
<p align="left">In this unit test, the only change from the previous is that instead of assigning the GreedyConstructorQuery specifically to Bastard, it's now assigned as the new default strategy. All specimens created by AutoFixture will be created by invoking their most greedy constructor.</p>
<p align="left">As always I find the default behavior more attractive, but the option to change behavior is there if you need it.</p>
</div>
<div id="comments">
    <hr>
    <h2 id="comments-header">
        Comments
    </h2>
    <div class="comment">
            <div class="comment-author"><a href="https://plus.google.com/+WestonMcNamee/about">Wes</a></div>
        <div class="comment-content">I seem to encountered a bug. It seems that the greedy constructor query & OmitAutoProperties don't play nice together when the constructor parameters fill in properties.
            <br/>I've submitted an issue for this: <a href="https://github.com/AutoFixture/AutoFixture/issues/320">Issue#320</a>
            <br/><pre class="csharp" style="font-family:monospace;"><ol><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0600FF; font-weight: bold;">namespace</span> JustATest</div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #008000;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">	<span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">Ploeh.AutoFixture</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">	<span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">Ploeh.AutoFixture.Kernel</span><span style="color: #008000;">;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">	<span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">Xunit</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">	<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> JustATest <span style="color: #008000;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">		<span style="color: #008000;">&#91;</span>Fact<span style="color: #008000;">&#93;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">		<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> GreedyConstructorAndOmitAutoProps<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">			<span style="color: #0600FF; font-weight: bold;">var</span> fixture <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> Fixture<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">			fixture<span style="color: #008000;">.</span><span style="color: #0000FF;">Customize</span><span style="color: #008000;">&lt;</span>Foo<span style="color: #008000;">&gt;</span><span style="color: #008000;">&#40;</span>c <span style="color: #008000;">=&gt;</span> c<span style="color: #008000;">.</span><span style="color: #0000FF;">FromFactory</span><span style="color: #008000;">&#40;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">				<span style="color: #008000;">new</span> MethodInvoker<span style="color: #008000;">&#40;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">					<span style="color: #008000;">new</span> GreedyConstructorQuery<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">			fixture<span style="color: #008000;">.</span><span style="color: #0000FF;">Customize</span><span style="color: #008000;">&lt;</span>Foo<span style="color: #008000;">&gt;</span><span style="color: #008000;">&#40;</span>c <span style="color: #008000;">=&gt;</span> c<span style="color: #008000;">.</span><span style="color: #0000FF;">OmitAutoProperties</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">			<span style="color: #0600FF; font-weight: bold;">var</span> foo <span style="color: #008000;">=</span> fixture<span style="color: #008000;">.</span><span style="color: #0000FF;">Create</span><span style="color: #008000;">&lt;</span>Foo<span style="color: #008000;">&gt;</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">			Assert<span style="color: #008000;">.</span><span style="color: #0000FF;">NotNull</span><span style="color: #008000;">&#40;</span>foo<span style="color: #008000;">.</span><span style="color: #0000FF;">myStr</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">		<span style="color: #008000;">&#125;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">	<span style="color: #008000;">&#125;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">	<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> Foo <span style="color: #008000;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">		<span style="color: #0600FF; font-weight: bold;">public</span> Foo<span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">string</span> myStr<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">			<span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">myStr</span> <span style="color: #008000;">=</span> myStr<span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">		<span style="color: #008000;">&#125;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">		<span style="color: #0600FF; font-weight: bold;">public</span> Foo<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">		<span style="color: #008000;">&#125;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">		<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">string</span> myStr <span style="color: #008000;">&#123;</span> <span style="color: #0600FF; font-weight: bold;">get</span><span style="color: #008000;">;</span> <span style="color: #0600FF; font-weight: bold;">set</span><span style="color: #008000;">;</span> <span style="color: #008000;">&#125;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">	<span style="color: #008000;">&#125;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #008000;">&#125;</span></div></li></ol></pre>
        </div>
        <div class="comment-date">2014-10-17 6:48 UTC</div>
    </div>
  <div class="comment">
    <div class="comment-author"><a href="http://blog.ploeh.dk">Mark Seemann</a></div>
    <div class="comment-content">
      <p>
        Wes, thank you for writing. Let's continue the discussion over at that <a href="https://github.com/AutoFixture/AutoFixture/issues/320">GitHub issue</a>.
      </p>
    </div>
    <div class="comment-date">2014-10-18 8:26 UTC</div>
  </div>
</div>
